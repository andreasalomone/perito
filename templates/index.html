<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genera una Perizia</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="loader-overlay" class="loader-overlay">
        <div class="loader-content">
            <div class="spinner"></div>
            <h2>Stiamo generando la tua perizia...</h2>
            <p>Questa operazione potrebbe richiedere qualche minuto.</p>
            <div class="timer">Tempo trascorso: <span id="timer-seconds">0</span>s</div>
            <div class="logs">
                <ul id="log-list">
                    <!-- Log messages will be injected here by JS -->
                </ul>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>AI Insurance Report Generator</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flash-messages">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('upload_files') }}" method="post" enctype="multipart/form-data">
            <label for="files">Carica Documenti (PDF, DOCX, TXT, PNG, JPG, XLSX):</label>
            <input type="file" name="files[]" id="files" multiple required>
            <button type="submit">Genera Perizia</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.querySelector('form');
            const loaderOverlay = document.getElementById('loader-overlay');
            const fileInput = document.getElementById('files');
            const timerSpan = document.getElementById('timer-seconds');
            const logList = document.getElementById('log-list');

            let timerInterval;
            let seconds = 0;

            const logMessages = [
                { time: 1, message: "Avvio del processo di generazione..." },
                { time: 3, message: "Caricamento dei documenti in corso..." },
                { time: 8, message: "Estrazione del testo dai documenti (OCR in corso)..." },
                { time: 15, message: "Analisi del contenuto e preparazione per l'invio all'AI..." },
                { time: 25, message: "L'intelligenza artificiale sta generando il report (questa è la fase più lunga)..." },
                { time: 50, message: "Quasi finito, finalizzazione del documento..." }
            ];

            function startLoader() {
                loaderOverlay.classList.add('visible');
                
                // Start timer
                seconds = 0;
                timerSpan.textContent = seconds;
                timerInterval = setInterval(() => {
                    seconds++;
                    timerSpan.textContent = seconds;
                }, 1000);

                // Clear previous logs and schedule new ones
                logList.innerHTML = '';
                logMessages.forEach(log => {
                    setTimeout(() => {
                        const li = document.createElement('li');
                        li.textContent = `[+${seconds}s] ${log.message}`;
                        logList.appendChild(li);
                        logList.scrollTop = logList.scrollHeight;
                    }, log.time * 1000);
                });
            }

            form.addEventListener('submit', function(e) {
                if (fileInput.files.length > 0) {
                    startLoader();
                } else {
                    // This case is typically handled by the 'required' attribute on the input
                    // but we can prevent submission here as a fallback.
                    e.preventDefault();
                    // You might want to show a custom alert or message here
                }
            });
        });
    </script>
</body>
</html> 